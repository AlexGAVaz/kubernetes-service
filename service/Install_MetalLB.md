
# MetalLB v0.14.3

### Подготовка

Необходимо переопределаить в конфигурации `kube-proxy` параметр `IPVS`, начиная с `Kubernetes` `v1.14.2`, должны включить строгий режим `ARP` в текущем кластере:

```shell
kubectl edit configmap -n kube-system kube-proxy
```

и установить:

```yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"
ipvs:
  strictARP: true
```

### Установка MetalLB

1. **Применение манифеста MetalLB**: для установки MetalLB, выполните следующую команду:

   ```bash
   kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.3/config/manifests/metallb-native.yaml
   ```

Этот манифест установит все необходимые компоненты `MetalLB`, пространстве имен `metallb-system`
и CRD, в кластере:

* `metallb-system/controller` `Deployment` - Это контроллер в масштабах всего кластера, который обрабатывает назначение IP-адресов.
* `metallb-system/speaker` `Daemonset` - Это компонент, который говорит о протоколе (протоколах) по вашему выбору, чтобы сделать услуги доступными.
* `Service accounts` Сервисный аккаунт `controller` и `speaker`, а также разрешения `RBAC`, необходимые для работы компонентов.
* `SRD` - `Custom Resource Definitions`, позволяют настраивать и управлять `MetalLB` на более гранулированном уровне, используя возможности `Kubernetes API`. Предоставляют механизм для декларативного описания желаемого состояния сетевых конфигураций, таких как пулы IP-адресов и стратегии их рекламирования. Вот основные `CRD`, вводимые `MetalLB`:
  * `IPAddressPool` - используется для определения пула IP-адресов, которые `MetalLB` может назначать сервисам типа `LoadBalancer`. Он позволяет администраторам указывать один или несколько диапазонов IP-адресов, которые будут доступны для назначения. Можно определить пул IP-адресов для внешних сервисов и отдельный пул для внутренних сервисов, управляя тем, какие адреса выделяются для различных типов нагрузки.
  * `L2Advertisement` - управляет рекламой (анонсированием) адресов из `IPAddressPool` в локальной сети в режиме `Layer 2`. Он позволяет настроить, какие ноды кластера будут рекламировать назначенные IP-адреса, используя стандартные сетевые протоколы, такие как `ARP (Address Resolution Protocol)`. Можно настроить, чтобы только определенные ноды в кластере рекламировали IP-адреса, основываясь на их роли, местоположении или других характеристиках.
  * `BGPPeer` (если используется BGP) для кластеров, использующих `BGP` (Border Gateway Protocol) для рекламирования IP-адресов, `BGPPeer` `CRD` позволяет определять конфигурации `BGP` соседей. Это включает в себя настройки для установления `BGP` сессий с внешними маршрутизаторами. Можно настроить `BGP` сессии между нодами кластера и внешними маршрутизаторами, чтобы динамически рекламировать маршруты к сервисам, назначенным в кластере.

### Настройка MetalLB

Для настройки MetalLB используются два основных `CRD`: `IPAddressPool` для определения пулов IP-адресов и `L2Advertisement` для настройки рекламы в режиме `Layer 2`.

2. **Создание `IPAddressPool`**: для определения пула IP-адресов, который будет использоваться для сервисов типа `LoadBalancer`, создадим YAML файл, например `ip-address-pool.yaml`, с следующим содержанием:

   ```yaml
   apiVersion: metallb.io/v1beta1
   kind: IPAddressPool
   metadata:
     name: LB-ip-pool
     namespace: metallb-system
   spec:
     addresses:
     - 192.168.53.161-192.168.53.162
   ```

   Применим его с помощью команды:

   ```bash
   kubectl apply -f ip-address-pool.yaml
   ```

3. **Создание `l2advertisement`**: это позволит объявлять (рекламировать) IP-адреса из пула в сети. Создадим файл `l2advertisement.yaml` с содержанием:

   ```yaml
   apiVersion: metallb.io/v1beta1
   kind: L2Advertisement
   metadata:
   name: LB-l2advertisement
   namespace: metallb-system
   ```

   И применим его:

   ```bash
   kubectl apply -f l2advertisement.yaml
   ```

Теперь `MetalLB` настроен и готов к использованию в кластере `Kubernetes`.
Сервисы типа `LoadBalancer`, которые будут созданы, будут автоматически получать IP-адреса из указанного пула `192.168.53.161-192.168.53.162`, и эти адреса будут объявлены в вашей локальной сети в режиме `Layer 2`.

### Проверка работы

После настройки создать тестовый сервис типа `LoadBalancer` для проверки работы `MetalLB`. Сервис автоматически получит IP-адрес из настроенного пула, и можно обращаться к этому сервису из локальной сети.

Таким образом, использование `CRD` для конфигурации предоставляет более гибкие и мощные возможности для управления сетевыми ресурсами в Kubernetes с помощью `MetalLB`.
